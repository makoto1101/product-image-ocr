import streamlit as st

# --- 1. ダイアログ（モーダルウィンドウ）の定義 ---
# width="large" に設定
@st.dialog("操作マニュアル", width="large")
def show_instructions():    
    # --- スクロールエリアの定義 ---
    # height=500 (ピクセル) に設定することで、中身がこれを超えるとスクロールバーが出ます
    # border=True で枠線を付けて、エリアを分かりやすくしています
    with st.container(height=700, border=True):
        st.markdown("""
        <span style="color: #4e4e4e; font-size: 15px;">OCR（Optical Character Recognition/Reader）とは、画像に含まれる文字を認識し、テキストデータに変換する技術のことです。本アプリではこの技術を活用し、Google Driveに保存された商品画像をAIで解析することで、テキストの抽出から誤字脱字のチェック、NENGの内容量情報との比較までを自動で行います。</span>

        ---

        ## 📂 1. Google Drive 設定
                    
        ### ① マイドライブに画像フォルダを準備
        対象の画像フォルダをご自身の「**マイドライブ**」に用意（コピー）してください。共有ドライブからマイドライブへのコピーは[こちら](https://script.google.com/a/macros/steamship.co.jp/s/AKfycbxfHwqxcl-tAnUOsx8OT9lHa2c4DV13VivUMt6CFC6dtDRweQOI53RT5mAP-5VVB5KF/exec)をご利用ください。

        > **⚠️ 注意：共有ドライブは使用できません**
        >
        > SSのセキュリティ上、外部の「サービスアカウント」を共有ドライブのフォルダに共有することができません。必ずマイドライブ上のフォルダをご使用ください。
        >
        > ※ サービスアカウントとは、アプリがGoogleドライブやスプレッドシートを自動操作するために使用する専用のアカウントです。
                    
        フォルダの構成と画像ファイル名が下記のルールに従っていることを確認してください。
        > URL指定用フォルダ ＞ ポータル名等が付いたフォルダ（複数OK）＞ 画像ファイル（複数OK）
        >
        > 画像ファイル名：品番.jpg 　例） aedg001.jpg、 aedg001-1.jpg
                
        ### ② サービスアカウントの共有
        ①で用意したマイドライブ上のフォルダに、以下のサービスアカウントを「**閲覧者**」以上の権限で共有します。
        """, unsafe_allow_html=True)

        # コピーしやすいように st.code で表示
        st.code("ocr-app@ai-project-427106.iam.gserviceaccount.com", language=None)

        st.markdown("""
        ### ③ 画像フォルダのURLを入力
        1. サイドバーにある「**読み込み元のGoogleドライブフォルダURL**」入力欄に、①で用意したマイドライブ上のフォルダURLを貼り付けます。
        2. 「**ドライブから読み込み**」ボタンをクリックしてください。

        ✅ **読み込み完了後**
        「2. 実行設定」エリアの各項目（事業者コード・品番）が選択可能になります。

        ---

        ## ⚙️ 2. 実行設定

        ### ① 自治体を選択
        セレクトボックスから該当の自治体を選択してください。（文字入力による検索も可能です）

        * **役割:** NENG APIを使用して、正しい「内容量」データを取得するために使用します。
        * **注意:** 選択した自治体と品番に関連性がない場合、結果の「NENG 内容量」列は空欄になります。

        > **💡 データ参照元について**
        >
        > 自治体リストは指定の「Googleスプレッドシート」を参照しています。スプレッドシート側を更新すると、本アプリの選択肢も自動的に更新されます。

        ### ② 事業者コード・品番を選択
        OCRを実行したい対象を選択します。

        * **事業者コード:** 対象の事業者を選択します。
        * **品番:** 特定の品番、または「すべて」を選択できます。
            * `すべて` を選択した場合：その事業者コードに紐づく**全ての品番**の画像を処理します。

        > **🚫 処理枚数の上限**
        >
        > 一度にOCR処理ができる画像の枚数は **最大500枚** までです。これを超える場合は、分割して実行してください。

        ---

        ## 🚀 3. OCR実行

        1. 設定が完了したら、「**OCR実行**」ボタンをクリックします。
        2. 確認メッセージが表示されますので、内容を確認して「**OK**」をクリックしてください。
        3. 自動的にOCR処理が開始されます。

        ---

        ## 📊 4. OCR実行結果の確認

        背景色が<span style="color: red;">**赤色**</span>のレコード（行）は「要確認」のレコードとなります。
        「テキスト比較」「誤字脱字」「内容量比較」「エラー検出」列のいずれかで指摘がある場合は、該当のレコードが赤色となります。異常なしのレコードは無色となります。

        ### 【判定の種類】

        | 列名 | 異常なし | 要確認 | その他 |
        | :--- | :--- | :--- | :--- |
        | **テキスト比較** | <span style="color: blue;">OK！</span> | <span style="color: red;">差分あり</span> | <span style="color: gray;">比較対象なし</span> |
        | **誤字脱字** | <span style="color: blue;">OK！</span> | <span style="color: red;">(指摘内容)</span> | <span style="color: gray;">-</span> |
        | **内容量比較** | <span style="color: blue;">OK！</span> | <span style="color: red;">要確認</span> | <span style="color: gray;">内容量記載なし</span> |
        | **エラー検出** | <span style="color: blue;">-</span> | <span style="color: red;">テキスト検出失敗あり</span> | <span style="color: gray;">-</span> |

        > **ℹ️ 推奨**
        >
        > OCR結果のデータ数が多い場合は、Web画面が重くなることがある為、「スプレッドシートに保存」への出力を推奨しています。

        ---

        ## 💾 5. スプレッドシートに保存（※必要に応じて）

        ### ① マイドライブへのコピーと共有設定
        [こちらのスプレッドシート](https://docs.google.com/spreadsheets/d/1Hi4TYK16lsezrp2Hnv6ICQQzLPcb_xhkneOEzXMk9Rc)をマイドライブにコピー または、SSのテンプレートギャラリーをクリックして、コピーしたスプレッドシートにサイドメニューのサービスアカウントを「**編集者**」権限で共有してください。
        
        このスプレッドシートには、画像をセルに埋め込むためのスクリプトが事前に組み込まれています。

        > **⚠️ 注意：専用シートをご利用ください**
        > 
        > 指定のスプレッドシート以外でも、サービスアカウントを共有すればテキストデータの保存は可能ですが、**画像を表示することができません**。
        > 
        > Google APIの仕様上、外部から画像を直接貼り付けることができないため、画像表示用のスクリプトが含まれる上記スプレッドシートをご利用ください。

        ### ② 保存の実行
        1. 「**GoogleスプレッドシートURL**」のテキストエリアに、コピーしたスプレッドシートのURLを入力してください。
        2. 「**保存**」ボタンを押下すると、スプレッドシートにOCRの結果が出力されます。
        """, unsafe_allow_html=True)


    # # --- 閉じるボタン ---
    # # スクロールエリアの外に配置することで、常に下部に表示させます
    # if st.button("閉じる", width="stretch"):
    #     st.rerun()